# Architect

Personal CI server

## Deploying

We use a normal Ansible vars file `architect.cfg` and vault file `architect.vault.cfg`.
We also use Ansible best practice of having all vault variables prepended with `vault_`,
and setting a non-prepended version in the vars file,
to make it clear where the variable in question is defined when grepping.

See the vars file for variables and comments on how to obtian them.

One rough edge: `ipsec_architect.conf`.
- Resides in `roles/cfn_architect_ci/files`
- Copied from one generated by Algo
- Modified for this repository - not suitable out of the box
- If you have questions, compare the existing version with a new one generated by Algo
- Possibly should be parameterized as a template instead

Once you have these things configured, you can deploy with a simple command:

    ansible-playbook deploy.yaml --ask-vault-pass

## Troubleshooting 

### Connecting over SSH for troubleshooting

Once the host key is verified,
simply use whatever SSH key pair is associated with the instance -
that is,
whatever key pair was specified by the `KeyName` parameter to the CFN template.
In the example below,
I also supply `-o UserKnownHostsFile=/dev/null` on the command line,
which prevents ssh from saving the host key to `~/.ssh/known_hosts`
on the SSH client machine.

    ssh -o UserKnownHostsFile=/dev/null admin@<IP ADDRESS> -i /path/to/keypair.pem

### Troubleshooting cfn-init

View userdata (from the instance itself)

    ```sh
    wget -q -O - http://169.254.169.254/latest/user-data
    ```

If the `cfn-init` command is failing,
comment out the `cfn-init` invocation in userdata,
deploy the stack,
run the command manually the same way it would be run by userdata,
and then check logs at `/var/log/cfn-*.log`.

You can also use the `cfn-get-metadata` command to see the `AWS::CloudFormation::Init` metadata from the template.
You can find the call to `cfn-init` in the CloudFormation template,
and then replace `cfn-init` with `cfn-get-metadata` to see the metadata exactly as `cfn-init` would.
For example:

    ```sh
    # The cfn-init call from userdata:
    cfn-init -v --stack "$stackname" --resource ArchitectInstance --region "$region"
    # Call cfn-get-metadata instead:
    cfn-get-metadata -v --stack "$stackname" --resource ArchitectInstance --region "$region"
    ```
