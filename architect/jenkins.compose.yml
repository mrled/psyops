version: "3.1"
services:

  jenkins:
    image: jenkins/jenkins:lts
    ports:
      - "80:8080"
      - "443:8443"
    volumes:
      - jenkins_home:/var/jenkins_home
      - type: volume
        source: jenkins_cert
        target: /var/jenkins_cert
        read_only: true
    deploy:
      replicas: 1
    command: --httpPort=-1 --httpsPort=8443 --httpsCertificate="/var/jenkins_cert/certificates/architect.infra.micahrl.com.crt" --httpsPrivateKey="/var/jenkins_cert/certificates/architect.infra.micahrl.com.key"

  inflatable-wharf:
    image: mrled/inflatable-wharf:latest
    deploy:
      replicas: 1
    environment:
      - ACME_LETSENCRYPT_EMAIL=psyops@micahrl.com
      - ACME_DOMAIN=architect.infra.micahrl.com
      - ACME_DNS_AUTHENTICATOR=gandi
      - ACME_SERVER=production
      - ACME_FREQUENCY=monthly
      - ACME_SECRETS_ENV_FILE=/run/secrets/lego_acme_env_file
    secrets:
      - source: lego_acme_env_file
        target: lego_acme_env_file
        mode: 0444
    volumes:
      - jenkins_cert:/srv/inflatable-wharf

  # backupmanager:
  #   image: alpine:latest
  #   volumes:
  #     - jenkins_home:/var/jenkins_home
  #   deploy:
  #     replicas: 1

volumes:
  jenkins_home:
  jenkins_cert:

secrets:
  lego_acme_env_file:
    file: ./lego-acme-secret-env.txt
