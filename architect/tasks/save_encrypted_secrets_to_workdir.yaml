---

- name: Define secret-related facts
  set_fact:
    decrypted_secrets_dir: "{{ workdir }}/decrypted"
    s3_upload_src_dir: "{{ workdir }}/s3_upload"
    architect_instance_secrets:
      architect_ssh_host_ed25519_key: "{{ architect_ssh_host_ed25519_key_b64 | b64decode }}"
      algo_vpn_key: "{{ algo_vpn_key_b64 | b64decode }}"
      algo_vpn_cert: "{{ algo_vpn_cert_b64 | b64decode }}"
      architect_ssh_host_ecdsa_key: "{{ architect_ssh_host_ecdsa_key_b64 | b64decode }}"
    architect_instance_secrets_passphrase: "{{ lookup('password', '/dev/null') }}"

- name: Create s3_upload directory
  command: mkdir -p "{{ s3_upload_src_dir }}"
  args:
    creates: "{{ s3_upload_src_dir }}"

- name: Save unencrypted secrets to workdir
  copy:
    content: "{{ item.value }}"
    dest: "{{ decrypted_secrets_dir }}/{{ item.name }}"
  with_dict: "{{ architect_instance_secrets }}"

- name: Encrypt secrets
  command: >
    gpg
    --passphrase "{{ architect_instance_secrets_passphrase }}"
    --output "{{ s3_upload_src_dir }}/{{ item.name }}.gpg"
    --symmetric
    "{{ decrypted_secrets_dir }}/{{ item.name }}"
  with_dict: "{{ architect_instance_secrets }}"

- name: Remove unencrypted secrets from workdir
  file:
    state: absent
    path: "{{ decrypted_secrets_dir }}/{{ item.name }}"
  with_dict: "{{ architect_instance_secrets }}"
