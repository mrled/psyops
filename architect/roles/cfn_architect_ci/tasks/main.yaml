---

- block:

  - name: Deploy the Architect CI template
    cloudformation:
      aws_access_key: "{{ aws_access_key }}"
      aws_secret_key: "{{ aws_secret_key }}"
      stack_name: "{{ architect_ci_stack_name }}"
      state: "present"
      disable_rollback: true
      region: "{{ aws_region }}"
      template: "roles/cfn_architect_ci/files/architect.ci.cfn.yaml"
      template_parameters:
        Ec2InstanceProfileName: "{{ architect_iam_profile_name }}"
        VpnIpsecUserConf: "{{ lookup('file', 'ipsec_architect.conf') }}"
        VpnIpsecUserSecrets: "{{ algo_ipsec_secrets }}"
        VpnKeyEncrypted: "{{ algo_vpn_key_kmsencrypted }}"
        VpnCert: "{{ algo_vpn_cert_b64 | b64decode }}"
        VpnCaCert: "{{ algo_cacert_b64 | b64decode }}"
        VpnKeepaliveHost: "{{ vpn_keepalive_host }}"
        KmsId: "{{ architect_kms_id }}"
        KeyPairName: "{{ architect_ci_keypair_name }}"
        SshHostEcdsaKeyEncrypted: "{{ architect_ssh_host_ecdsa_key_kmsencrypted }}"
      tags:
        Environment: Architect
    register: architect_ci_stack_result

  - set_fact:
      architect_ip_address: "{{ architect_ci_stack_result.stack_outputs.ArchitectIpAddress }}"

  - name: Save known_hosts file
    copy:
      content: "{{ architect_ip_address }} {{ ssh_host_public_ecdsa_key }}"
      dest: "{{ workdir }}/known_hosts"

  - name: Success!
    vars:
      ssh_cmd: >
        ssh
        -o UserKnownHostsFile={{ workdir }}/known_hosts
        -i /path/to/{{ architect_ci_keypair_name }}.pem
        admin@{{ architect_ip_address }}
      msg: |
          Connecting to Architect, for debugging
          IP address          {{ architect_ip_address }}
          ECDSA fingerprint   {{ ssh_host_public_ecdsa_key_fingerprint }}
          SSH command         {{ ssh_cmd }}
    debug:
      msg: "{{ msg.split('\n') }}"

  rescue:
  - debug: var=architect_ci_stack_result
  - fail:
      msg: Deployment has failed :(