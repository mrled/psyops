apiVersion: v1
kind: ConfigMap
metadata:
  name: build-job-config
  namespace: clustergit
data:
  gitserver.buildah.sh: |-
    #!/bin/sh
    set -eu

    # Get config vars
    imgname="${CLUSTERGIT_IMAGENAME}"
    imgtag="${CLUSTERGIT_IMAGETAG}"
    regserver="${CLUSTERGIT_REGISTRY}"
    reguser="${CLUSTERGIT_REGISTRY_USERNAME}"
    regpass="${CLUSTERGIT_REGISTRY_PASSWORD}"

    # Configure buildah to allow HTTP registry
    export BUILD_REGISTRY_SOURCES="{\"insecureRegistries\": [\"$regserver\"], \"blockedRegistries\": [], \"allowedRegistries\": []}"

    # Log in first
    echo "Logging in to $regserver as $reguser..."
    buildah --log-level=debug login --username "$reguser" --password "$regpass" --tls-verify=false "$regserver"
    echo "Logged in to $regserver as $reguser."

    # No more secrets at this point, show what commanes we are running
    set -x

    # Build the image
    container="$(buildah from alpine:3.19)"
    buildah run "$container" -- apk add --no-cache git openssh-server
    buildah run "$container" -- adduser -h /home/git -s /usr/bin/git-shell -D git
    buildah run "$container" -- mkdir -p /home/git/.ssh
    buildah run "$container" -- chown git:git /home/git/.ssh
    #buildah run "$container" -- rm -f /etc/motd
    buildah config --cmd "/usr/sbin/sshd -De" "$container"
    buildah config --port 22 "$container"
    buildah commit "$container" "$imgname"
    buildah tag "$imgname" "$regserver/repository/$imgname:$imgtag"
    buildah push --tls-verify=false "$imgname" "$regserver/repository/$imgname:$imgtag"
