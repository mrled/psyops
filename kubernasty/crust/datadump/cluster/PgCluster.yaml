apiVersion: postgresql.cnpg.io/v1
kind: Cluster
metadata:
  name: datadump-pg-cluster
  namespace: datadump
spec:
  instances: 3
  bootstrap:
    initdb:
      database: datadump
      # A superuser that we can use to set permissions in the dbinit job
      owner: datadump
      secret:
        name: datadump-pg
  storage:
    size: 50Gi
    # Do not use storage replication at the Ceph level (1rep means no replication),
    # because we are doing data replication at the Postgres level (instances: 3)
    storageClass: cephalopodblk-nvme-1rep

  postgresql:
    ldap:
      server: dirsrv.directory.svc.cluster.local
      port: 636
      scheme: ldaps
      bindSearchAuth:
        baseDN: dc=micahrl,dc=me
        bindDN: uid=authenticator,ou=services,dc=micahrl,dc=me
        bindPassword:
          name: authenticator
          key: password
        searchFilter: (&(objectClass=inetOrgPerson)(memberOf=cn=datadump-connect,ou=groups,dc=micahrl,dc=me)(uid=%u))

    # pg_hba:
    #   # Allow the postgres superuser to connect locally with peer authentication
    #   - host all postgres all trust
    #   # Allow the datadumpadmin user to connect with md5 authentication
    #   - host datadump datadumpadmin all md5
    #   # Allow other users to authenticate with LDAP
    #   - host all all all ldap ldapserver=dirsrv.directory.svc.cluster.local ldapport=636 ldaptls=1 ldapbinddn="uid=authenticator,ou=services,dc=micahrl,dc=me" ldapbindpasswd=authenticator-password ldapsearchattribute=uid ldapbasedn="dc=micahrl,dc=me" ldapsearchfilter="(&(objectClass=inetOrgPerson)(memberOf=cn=datadump-connect,ou=groups,dc=micahrl,dc=me))"
