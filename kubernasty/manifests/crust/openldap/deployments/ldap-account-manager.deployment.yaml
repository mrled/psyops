apiVersion: apps/v1
kind: Deployment
metadata:
  name: ldap-account-manager
  namespace: openldap
  labels:
    app.kubernetes.io/name: ldap-account-manager
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: ldap-account-manager
  replicas: 1
  template:
    metadata:
      labels:
        app.kubernetes.io/name: ldap-account-manager
    spec:
      initContainers:
        - name: initial-configurator
          image: alpine:latest
          command: ["/bin/sh", "-c"]
          # We copy the LAM config always,
          # but the kubernasty.cfg file can be modified by the web UI itself,
          # so we only create that if it isn't already in the persistent storage.
          args:
            - |+
              # rm -rf /etc/ldap-account-manager/* /var/lib/ldap-account-manager/config/*

              mkdir -p /var/lib/ldap-account-manager/config

              echo "/etc/ldap-account-manager"
              ls -alF /etc/ldap-account-manager
              echo "/var/lib/ldap-account-manager"
              ls -alF /var/lib/ldap-account-manager
              echo "/ldap-account-manager-default"
              ls -alF /ldap-account-manager-default

              echo "Copying config.cfg..."
              cp -L /ldap-account-manager-default/config.cfg /var/lib/ldap-account-manager/config
              #cp -L /ldap-account-manager-default/config.cfg /etc/ldap-account-manager
              cat "/var/lib/ldap-account-manager/config.cfg"

              if ! test -e /var/lib/ldap-account-manager/config/lam.cfg; then
                echo "Copying kubernasty.DEFAULT.cfg... to lam.cfg"
                cp -L /ldap-account-manager-default/kubernasty.DEFAULT.cfg /var/lib/ldap-account-manager/config/lam.cfg
              else
                echo "lam.cfg already exists"
              fi;
              cat /var/lib/ldap-account-manager/config/lam.cfg

              # UID 33 is www-data in the LAM container
              chown 33 \
                /var/lib/ldap-account-manager/config/config.cfg \
                /var/lib/ldap-account-manager/config/lam.cfg

              ls -alF \
                /var/lib/ldap-account-manager/config \
                /etc/ldap-account-manager

          volumeMounts:
            - name: ldap-account-manager-etc-vol
              mountPath: /etc/ldap-account-manager
            - name: ldap-account-manager-varlib-vol
              mountPath: /var/lib/ldap-account-manager/config
            - name: ldap-account-manager-default-config-vol
              mountPath: /ldap-account-manager-default
      containers:
        - name: ldap-account-manager
          # image: docker.io/nginx:latest
          image: docker.io/ldapaccountmanager/lam:stable
          imagePullPolicy: "Always"
          env:
            #
            # LAM setup
            #
            # skip LAM preconfiguration (lam.conf + config.cfg), values: (true/false)
            # If set to true the other variables below have no effect.
            - name: LAM_SKIP_PRECONFIGURE
              value: "true"
            # domain of LDAP database root entry, will be converted to dc=...,dc=...
            - name: LDAP_DOMAIN
              value: "kubernasty.micahrl.com"
            # LDAP base DN to overwrite value generated by LDAP_DOMAIN
            - name: LDAP_BASE_DN
              value: "dc=kubernasty,dc=micahrl,dc=com"
            # # LDAP users DN to overwrite value provided by LDAP_BASE_DN
            # - name: LDAP_USERS_DN
            #   value: "ou=people,dc=kubernasty,dc=micahrl,dc=com"
            # # LDAP groups DN to overwrite value provided by LDAP_BASE_DN
            # - name: LDAP_GROUPS_DN
            #   value: "ou=groups,dc=kubernasty,dc=micahrl,dc=com"
            # LDAP server URL
            - name: LDAP_SERVER
              value: "ldaps://openldap:636"
            # LDAP admin user (set as login user for LAM)
            - name: LDAP_USER
              value: "cn=admin,dc=kubernasty,dc=micahrl,dc=com"
            # default language, e.g. en_US, de_DE, fr_FR, ...
            - name: LAM_LANG
              value: "en_US"
            # LAM configuration master password and password for server profile "lam"
            - name: LAM_PASSWORD
              valueFrom:
                secretKeyRef:
                  key: lamAdminPass
                  name: ldap-account-manager

            # configuration database (files or mysql)
            - name: LAM_CONFIGURATION_DATABASE
              value: "files"

            - name: VIRTUAL_HOST
              value: accounts.kubernasty.micahrl.com
            - name: VIRTUAL_PORT
              value: "443"

            # #
            # # docker-compose only, LDAP server setup
            # #
            # # LDAP organisation name for OpenLDAP
            # LDAP_ORGANISATION="LDAP Account Manager Demo"
            # # LDAP admin password
            # LDAP_ADMIN_PASSWORD=adminpw
            # # password for LDAP read-only user
            # LDAP_READONLY_USER_PASSWORD=readonlypw
          ports:
            - name: lam-web
              containerPort: 80
          volumeMounts:
            # - name: ldap-account-manager-etc-vol
            #   mountPath: /etc/ldap-account-manager
            - name: ldap-account-manager-varlib-vol
              mountPath: /var/lib/ldap-account-manager/config
      volumes:
        - name: ldap-account-manager-varlib-vol
          persistentVolumeClaim:
            claimName: ldap-account-manager-varlib-claim
        - name: ldap-account-manager-etc-vol
          persistentVolumeClaim:
            claimName: ldap-account-manager-etc-claim
        - name: ldap-account-manager-default-config-vol
          configMap:
            name: ldap-account-manager-conf
