# wiki.micahrl.com

Currently just a testing ground for some things.

## Initial setup

This just needs to be done once,
recorded here so I don't forget how it works.

```sh
# Log in
flyctl auth login

# Create fly.toml
flyctl launch --no-deploy --name com-micahrl-wiki

# Make a 1GB volume
flyctl volumes create data --app com-micahrl-wiki -s 1

flyctl secrets set \
    LITESTREAM_ACCESS_KEY_ID=XXX \
    LITESTREAM_SECRET_ACCESS_KEY=YYY

# Edit fly.toml until it looks like the version in the repo now.
# EXCEPTIONS:
# 1. Set the URL to the fly.dev name, like
#   [env]
#     url = "https://com-micahrl-wiki.fly.dev"
#   We set it to the final URL later

# Deploy
flyctl deploy

# Set CNAME for wiki.micahrl.com to com-micahrl-wiki.fly.dev

flyctl certs add wiki.micahrl.com

# Change url in fly.toml to `https://wiki.micahrl.com` and redeploy

flyctl deploy

# Go to https://wiki.micahrl.com and set up the admin account and first settings.
# Do this quickly as it will let you set any password on first run.

# 1GB RAM is the wiki.js minimum requirement
fly scale memory 1024
```

## Inspecting the wiki.js Dockerfile

For some reason this is not in their repo, I guess it's autogenerated or some shit.

I used a command like this:

```sh
dockcer pull requarks/wiki
docker inspect --format='{{range $e := .Config.Env}}
ENV {{$e}}
{{end}}{{range $e,$v := .Config.ExposedPorts}}
EXPOSE {{$e}}
{{end}}{{range $e,$v := .Config.Volumes}}
VOLUME {{$e}}
{{end}}{{with .Config.User}}USER {{.}}{{end}}
{{with .Config.WorkingDir}}WORKDIR {{.}}{{end}}
{{with .Config.Entrypoint}}ENTRYPOINT {{json .}}{{end}}
{{with .Config.Cmd}}CMD {{json .}}{{end}}
{{with .Config.OnBuild}}ONBUILD {{json .}}{{end}}' requarks/wiki
```

That results in

```Dockerfile
ENV PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
ENV NODE_VERSION=16.15.0
ENV YARN_VERSION=1.22.18
EXPOSE 3000/tcp
EXPOSE 3443/tcp
VOLUME /wiki/data/content
USER node
WORKDIR /wiki
ENTRYPOINT ["docker-entrypoint.sh"]
CMD ["node","server"]
```

Via:

- <https://stackoverflow.com/questions/48716536/how-to-show-a-dockerfile-of-image-docker>
- <https://stackoverflow.com/questions/19104847/how-to-generate-a-dockerfile-from-an-image/48444917#48444917>

## Wiki configuration

- Create a homepage for the wiki.
    - It will prompt you to do this after your first login
    - Give it the tag `public`
- Change Guest group so it only has access to public pages
    - Admin area -> Groups -> Guest -> Page Rules tab
    - Allow `read:pages` and `read:assets` but not `read:comments`.
    - If tag matches `public`.
    - You must prohibit seeing comments, or else you'll get an error on every page load that says "An unexpected error occurred"
    - Require the `public` tag so that pages are private by default

## To do

- Try to restore from S3 replica if there is no database at `$DB_FILEPATH`
- Show how restores work in general