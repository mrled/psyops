---

- name: Add Docker repo
  yum_repository:
    name: docker
    description: docker
    # Got this baseurl by reading Docker install manual,
    # found 'dnf config-manager --add-repo https://REPOURL' command,
    # visiting that REPOURL, and picking docker-ce-stable
    baseurl: https://download.docker.com/linux/fedora/$releasever/$basearch/stable

- name: Install Docker
  dnf:
    name:
      - containerd.io
      - docker-ce
      - docker-ce-cli
      - python3-docker
    state: latest
    update_cache: yes

- name: Create Unifi controller group
  group: name=unifi
  register: group_result

- name: Create Unifi controller user
  user: name=unifi group=unifi groups=docker
  register: user_result

- name: Start docker service
  systemd: name=docker state=started enabled=yes

# Adapted from e.g.
# firewall-cmd --permanent --zone=trusted  --add-interface=docker0
# firewall-cmd --permanent --zone=trusted  --add-port=8443/tcp
# ...
# firewall-cmd --reload
- name: Allow Unifi ports through the firewall
  firewalld: port={{ item }} permanent=yes zone=trusted state=enabled immediate=yes
  with_items:
    - 8080/tcp
    - 8443/tcp
    - 8843/tcp
    - 8880/tcp
    - 3478/udp
    - 6789/tcp
    - 10001/udp

# Stupid hack because Google networks are ipv4 only (?) and/or my DNS name is ipv4 only
# but Docker insists on ipv6 when it can and netstat -an will NOT have it listen on ipv4
# ... might not actually be necessary b/c of immediate=yes above
- name: Get IPv4 address
  set_fact: ipv4addr={{ hostvars[inventory_hostname]['ansible_default_ipv4']['address'] }}

- name: Start the Unifi controller
  docker_container:
    name: unifi
    image: jacobalberty/unifi:stable
    state: started
    restart: yes
    restart_policy: unless-stopped
    network_mode: host
    init: yes
    volumes:
      - /srv/unifi-data:/unifi:rw
    ports:
      # - "8080/tcp"    # Device command and control
      # - "8443/tcp"    # Web interface and API
      # - "8843/tcp"    # HTTPS portal
      # - "8880/tcp"    # HTTP portal
      # - "3478/udp"    # STUN service
      # - "6789/tcp"    # Speed Test (unifi5 only)
      # - "10001/udp"   # UBNT discovery
      - "{{ ipv4addr }}:8080:8080/tcp"    # Device command and control
      - "{{ ipv4addr }}:8443:8443/tcp"    # Web interface and API
      - "{{ ipv4addr }}:8843:8843/tcp"    # HTTPS portal
      - "{{ ipv4addr }}:8880:8880/tcp"    # HTTP portal
      - "{{ ipv4addr }}:3478:3478/udp"    # STUN service
      - "{{ ipv4addr }}:6789:6789/tcp"    # Speed Test (unifi5 only)
      - "{{ ipv4addr }}:10001:10001/udp"  # UBNT discovery
    env:
      TZ: America/Chicago
      UNAS_UID0: false
      UNIFI_UID: user_result.uid
      UNIFI_GID: group_result.gid

