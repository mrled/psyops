---

- name: Install RPM packages
  dnf:
    name:
      - ruby
      - ruby-devel
      - transmission-daemon
    update_cache: yes
    state: latest

- name: Disable the RPM-provided transmission service
  service:
    name: transmission-daemon
    state: stopped
    enabled: no

- name: Remove RPM-provided transmission homedir
  file:
    path: /var/lib/transmission
    state: absent

- name: Link the real user's homedir to the right place


- name: Install transmission-rss
  gem:
    name: transmission-rss
    state: latest
    user_install: false

#- name: Create seedbox mountpoints
#  file:
#    state: directory
#    path: "{{ item.path }}"
#    owner: root
#    group: root
#    mode: "0755"
#  with_items: "{{ seedbox_mountpoints }}"

#- name: Configure seedbox mount files
#  copy:
#    content: |+
#      username={{ item.username }}
#      password={{ item.password }}
#    dest: "{{ item.credsfile }}"
#    owner: root
#    group: root
#    mode: "0600"
#  with_items: "{{ seedbox_mountpoints }}"

#- name: Mount seedbox mounts
#  mount:
#    path: "{{ item.path }}"
#    src: "{{ item.src }}"
#    fstype: "{{ item.fstype }}"
#    opts: credentials={{ item.credsfile }}
#    state: mounted
#  with_items: "{{ seedbox_mountpoints }}"

- name: getent seedbox local user
  getent: database=passwd key={{ seedbox_local_user }}
- name: Set seedbox Unix homedir
  set_fact:
    seedbox_homedir: "{{ getent_passwd[seedbox_local_user][4] }}"

- name: Ensure downloads/incompletes directories exist
  file:
    path: "{{ item }}"
    owner: "{{ seedbox_local_user }}"
    group: "{{ seedbox_local_group }}"
    mode: "0700"
    state: directory
  with_items:
    - "{{ seedbox_download_dir }}"
    - "{{ seedbox_incomplete_dir }}"
  notify: restart transmission

- name: Ensure watch directory exists (warning, allows world writes)
  file:
    path: "{{ item }}"
    owner: "{{ seedbox_local_user }}"
    group: "{{ seedbox_local_group }}"
    mode: "0777"
    state: directory
  with_items:
  - "{{ seedbox_watch_dir }}"

# see also https://unix.stackexchange.com/questions/520625/transmission-daemon-udp-failed-to-set-receive-send-buffer
- name: Set higher send/receive buffer sizes
  sysctl: name={{ item.name }} value={{ item.value }}
  with_items:
  - { name: 'net.core.rmem_max', value: 16777216 }
  - { name: 'net.core.wmem_max', value: 4194304 }

- name: Ensure transmission config and staging directories exist
  file:
    path: "{{ item }}"
    owner: "{{ seedbox_local_user }}"
    group: "{{ seedbox_local_group }}"
    mode: "0700"
    state: directory
  with_items:
    - "{{ seedbox_homedir }}/.config/transmission-daemon"
    - "{{ seedbox_homedir }}/.config/transmission-daemon-configstaging"

- name: Install the transmission config file to a staging area
  template:
    src: transmission-settings.json.j2
    dest: "{{ seedbox_homedir }}/.config/transmission-daemon-configstaging/settings.json"
    owner: "{{ seedbox_local_user }}"
    group: "{{ seedbox_local_group }}"
    mode: "0600"
  register: seedbox_xmission_config

- name: Stop transmission before changing config file (so it doesn't overwrite it)
  service:
    name: transmission-daemon
    state: stopped
  when: seedbox_xmission_config.changed

- name: Copy config file from staging to the real directory
  copy:
    src: "{{ seedbox_homedir }}/.config/transmission-daemon-configstaging/settings.json"
    dest: "{{ seedbox_homedir }}/.config/transmission-daemon/settings.json"
    remote_src: yes
  when: seedbox_xmission_config.changed

- name: Allow transmission through the firewall (trusted zone)
  firewalld: port={{ item }} permanent=yes zone=trusted state=enabled immediate=yes
  with_items:
  - "{{ seedbox_peer_port }}/udp"
  - "{{ seedbox_peer_port }}/tcp"
  - "{{ seedbox_rpc_port }}/udp"
  - "{{ seedbox_rpc_port }}/tcp"

- name: Allow transmission through the firewall (default zone)
  firewalld: port={{ item }} permanent=yes state=enabled immediate=yes
  with_items:
  - "{{ seedbox_peer_port }}/udp"
  - "{{ seedbox_peer_port }}/tcp"
  - "{{ seedbox_rpc_port }}/udp"
  - "{{ seedbox_rpc_port }}/tcp"

- name: Start transmission
  service:
    name: transmission-daemon
    state: started
    enabled: yes

- name: Install transmission-rss config file
  template:
    src: transmission-rss.conf.j2
    dest: /etc/transmission-rss.conf
    owner: "{{ seedbox_local_user }}"
    group: "{{ seedbox_local_group }}"
    mode: "0640"

- name: Install transmission-rss systemd unit
  copy:
    src: transmission-rss.service
    dest: /etc/systemd/system/transmission-rss.service
    owner: root
    group: root
    mode: "0644"
  register: install_transmission_rss_service

- name: systemd daemon-reexec
  systemd:
    daemon_reexec: yes
  when: install_transmission_rss_service.changed

- name: Start transmission-rss
  service:
    name: transmission-rss
    state: started
    enabled: yes
